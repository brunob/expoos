<INCLURE{fond=modeles/carte_gis,
	id_rubrique,
	id_map=_expo,
	point=non,
	fullscreen=oui}>
<BOUCLE_couleur(RUBRIQUES){id_rubrique}>[(#SET{couleur,#COULEUR})]</BOUCLE_couleur>
<BOUCLE_svg(DOCUMENTS){id_rubrique}{extension=svg}{0,1}>
[(#FICHIER|balise_svg)][(#SET{svg,oui})]
</BOUCLE_svg>
<BOUCLE_gpx(DOCUMENTS){id_rubrique}{extension=gpx}{0,1}>
<object data="#FICHIER" type="text/xml" width="0" height="0"></object>
[(#SET{gpx,#FICHIER})]
</BOUCLE_gpx>
<script type="text/javascript">
	;(function($){
		$('#map_expo').on('load', function(){
			// pictos perso pour les markers
			this.map.setGeoJsonFeatureIcon = function(feature, layer) {
				layer.setIcon(L.divIcon({ html: '<div><span></span></div>', className: 'marker-dot', iconSize: new L.Point(40, 40) }));
			}
			// pas de popup pour les markers, le click renvoie direct vers l'article
			this.map.setGeoJsonFeaturePopup = function(feature, layer) {
				layer.on('click', function(e){
					location = e.sourceTarget.feature.properties.url;
				});
			}
		});
		$('#map_expo').on('ready', function(){
			var map = this.map;
			// charger le geojson des points
			var geojson = <INCLURE{fond=gis_json,id_rubrique,objets=expo}>;
			map.parseGeoJson(geojson);[(#GET{svg}|oui)
			// afficher le SVG du plan en overlay
			var svgElement = document.querySelector('#plan'),
			bounds = L.latLngBounds(eval(svgElement.getAttribute('data-bbox')));
			L.svgOverlay(svgElement, bounds).addTo(map);][(#GET{gpx}|oui)
			var gpx = new L.GPX(['(#GET{gpx})'], {async: true, color: '[(#GET{couleur}|sinon{#666666})]'});
			gpx.on('loaded', function (e) {
				map.fitBounds(e.target.getBounds());
			});
			map.addLayer(gpx);]
			<BOUCLE_center(GIS){id_article}{annexe=''}>
			map.setView(\[[(#LAT)],[(#LON)]\],20);
			var i, count = 0;
			for (i in map._layers) {
				if (((map._layers[i].feature) && (map._layers[i].feature.id == #ID_ARTICLE)) || (map._layers[i].id && map._layers[i].id == #ID_ARTICLE)) {
					//map._layers[i]._icon.classList.add('focus');
					map._layers[i].bindPopup('<:expoos:carte_popup_ici|texte_script:>').openPopup();
					break;
				}
				count++;
			}
			$('#map_expo').hide();
			</BOUCLE_center>[(#GET{svg}|oui)
			// centrer la carte sur les bounds du SVG
			map.fitBounds(bounds);][(#GET{svg}|et{#GET{gpx}}|non)
			// centrer la carte sur les bounds du json
			map.fitBounds(L.geoJSON(geojson).getBounds());]
			<//B_center>
		});
})(jQuery);
</script>